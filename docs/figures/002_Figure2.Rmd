---
title: "Partial_Correlation_Viz"
author: "Lucas Gillenwater"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, root.dir = "~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/")
```

# Partial Correlation Visualization

This script utilized the results from the partial correlation analysis to create figures for publication. 

```{r loading data}
load("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/partial_correlation_results/partial_cor_gsea_results_8_31.RData")
load("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/partial_correlation_results/partial_correlation_gsea_results_formatted_8_31.RData")
load("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/partial_correlation_results/full_partial_correlation_results_8_31.RData")
load("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/partial_correlation_results/full_z_percent_8_31.RData")
load("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/differential_expression/gsea_results_diff_2023-09_08.RData")
load("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/differential_expression/differential_expression_results_2023-09-08.RData")
transcription_factors <- read.delim("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/data/transcription_factors.txt", header = F)

```


```{r data prep}
library(tidyverse)
### wide to long for each matrix in the list
wideToLong <- function(full_z_results) {
  res <- lapply(full_z_results, function(x) {
    x %>% 
      as.data.frame() %>%
      rownames_to_column("gene") %>%
      pivot_longer(values_to = "combined_Z", names_to = "cyt_met", cols = where(is.numeric) )
  })
}
long_z <- wideToLong(full_z_results )
```


#### Figure 2A
```{r percent difference plots}
library(tidyverse)
tmp_toplot <- full_results %>%
  filter(cluster == "T21") %>%
  filter(gene == "IDO1") %>%
  filter(cytokine ==  "IFN-gamma")

long_z[[1]] %>%
         filter(cyt_met %in% c("IFN-gamma-kynurenine", "IFN-gamma-acyl-C12 (O-dodecanoyl-carnitine)" )) %>%
  filter(gene == "IDO1")%>%
  dplyr::select(cytokine, metabolite, gene, cluster, cor_cyt_met_r, partial_cor_cyt_met_r) %>%
  pivot_longer(cols = -c(cytokine,metabolite, gene,cluster)) %>%
  mutate(name = c("direct correlation", "partial correlation"))

p1 <- ggplot(tmp_toplot, aes(x = as.factor(name), y = value, fill = name )) +
  geom_bar(stat = "identity") +
  theme_classic() +
  ylab("correlation coefficient") +
  theme(legend.position = "none") +
  xlab("")

pdf(paste0("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/partial_correlation_results/figures/percent_change.pdf"), width = 3, height = 3)
print(p1)
dev.off()


```

#### Figure 2B
```{r}

key_cyt_met <- "IFN-gamma-kynurenine"

single_rel_z <- long_z[[1]] %>%
  filter(`cyt_met` == key_cyt_met) %>%
  as.data.frame() %>%
  arrange(-combined_Z) %>%
  mutate(rank = row_number())


p1 <- ggplot(single_rel_z, aes(x = rank, y = combined_Z)) +
  geom_point() +
  geom_point(data = single_rel_z[single_rel_z$gene == "IDO1",], aes(x = rank, y = combined_Z),  color ="red")+
  annotate("text", y= single_rel_z[single_rel_z$gene == "IDO1","combined_Z"],x =single_rel_z[single_rel_z$gene == "IDO1","rank"]+ 1000, angle = 0,  label="IDO1", color = "red", size = 6) +
  geom_point(data = single_rel_z[single_rel_z$gene == "STAT1",], aes(x = rank, y = combined_Z),  color ="darkgreen")+
  annotate("text", y= single_rel_z[single_rel_z$gene == "STAT1","combined_Z"],x =single_rel_z[single_rel_z$gene == "STAT1","rank"]+ 1050, angle = 0,  label="STAT1", color = "darkgreen", size = 6)+
  theme_classic() +
  xlab("rank") +
  ylab("Z score")

pdf(paste0("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/partial_correlation_results/figures/",key_cyt_met,"Z_trend_plot.pdf"), width = 10, height = 6)
print(p1)
dev.off()



```

### Figure 2C

```{r}

key_gene <- "STAT1"

single_rel_z <- long_z[[1]] %>%
  filter(gene == key_gene) %>%
  as.data.frame() %>%
  arrange(-combined_Z) %>%
  mutate(rank = row_number())

p1 <- ggplot(single_rel_z, aes(x = rank, y = combined_Z)) +
  geom_point() +
  geom_point(data = single_rel_z[single_rel_z$cyt_met == "IFN-gamma-kynurenine",], aes(x = rank, y = combined_Z),  color ="red")+
  annotate("text", y= single_rel_z[single_rel_z$cyt_met == "IFN-gamma-kynurenine","combined_Z"],x =single_rel_z[single_rel_z$cyt_met == "IFN-gamma-kynurenine","rank"]+ 100, angle = 0,  label="IFN-gamma-kynurenine", color = "red", size = 6) +
  theme_classic() +
  xlab("rank") +
  ylab("Z score")

pdf(paste0("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/partial_correlation_results/figures/",key_gene,"Z_trend_plot.pdf"), width = 10, height = 6)
print(p1)
dev.off()
```


## Heatmaps of gsea results

```{r  data}
library(tidyverse)

toplot_clusters <- lapply(gsea_results_formatted, function(x) {
  x[,colSums(is.na(gsea_results_formatted[[1]])) <1]
})

toplot_clusters <- lapply(toplot_clusters, function(x) {
  x %>%
    dplyr::select(contains("NES"))
}) 

for(x in 2:7) {
  names(toplot_clusters[[x]]) <- names(toplot_clusters[[1]])
}

names(toplot_clusters) <-c("T21", "D21", 1,2,3,4,5)

```


## Figure 2D

```{r global heatmap}

pathways_all <- gmtPathways("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/data/pathway/h.all.v2023.1.Hs.symbols.gmt")
met_path <- get(load("/Users/lucas/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/data/pathway/metabolite_pathway.RData"))

```



library(ComplexHeatmap)
library(circlize)


fullHeatmap <- function(input, title) {
 col_fun = colorRamp2(c(min(input),0, max(input) ), c("white","gray", "red"))  
  var_order <- apply(input, 1, function(x) var(x))
  var_order <- var_order[order(var_order, decreasing = TRUE)]
  
  p1 <- Heatmap(
    as.matrix(input), 
    row_names_gp = gpar(fontsize = 8), 
    row_dend_reorder = FALSE, 
    row_order = names(var_order),
    row_title = "",
    column_names_gp = gpar(fontsize = 6), 
    column_names_rot = 60,
    show_column_names = FALSE,
    name = "NES", 
    column_title = title, 
    column_title_gp = gpar(fontsize = 12, fontface = "bold"),
    heatmap_legend_param = list(
      legend_direction = "horizontal"), 
    col = col_fun
  )
  pdf(paste0("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/partial_correlation_results/figures/",title,"_full_heatmap.pdf"))
  draw(p1,heatmap_legend_side="bottom")
  dev.off()
}

fullHeatmap(toplot_clusters[[1]], "T21")

```

## Heatmap overall of DS pathways

```{r heatmap of DS pathways}
DSPathwayHeatmap <- function(input, title, tolabel = "", DS_pathways) {

  
  input <- input %>%
    dplyr::filter(rownames(input) %in% DS_pathways)
  
  
  names(input) <- gsub(" NES", "", names(input))
  rownames(input) <- gsub("HALLMARK_","", rownames(input))
  rownames(input) <- gsub("_"," ", rownames(input))
  
  
  
  
  column_labels <- ifelse(names(input) %in% tolabel, names(input), "")
  
  col_fun = colorRamp2(c(min(input),0, max(input) ), c("white","gray", "red"))
  
  p1 <- Heatmap(
    as.matrix(input), 
    row_names_gp = gpar(fontsize = 10), 
    column_title = "cytokine-metabolite relationships",
    row_title_side = "left",
    column_names_gp = gpar(fontsize = 10), 
    column_names_rot = 90,
    show_row_names = FALSE,
    show_column_names = FALSE,
  #  row_labels = column_labels,
    name = "NES", 
  #  row_title = paste("T21"), 
    column_title_gp = gpar(fontsize = 12, fontface = "bold"),
    heatmap_legend_param = list(
      legend_direction = "horizontal"),
    col = col_fun
    
  )
  # pdf( "T21_pathway_heatmap.pdf")
   pdf(paste0("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/partial_correlation_results/figures/",title,"_DS_pathways_heatmap.pdf"), width = 12, height = 4)
  draw(p1,heatmap_legend_side="bottom")
  dev.off()
} 

 DS_pathways <- c("HALLMARK_INTERFERON_GAMMA_RESPONSE", 
                   "HALLMARK_INTERFERON_ALPHA_RESPONSE",
                   "HALLMARK_HEME_METABOLISM", 
                   "HALLMARK_INFLAMMATORY_RESPONSE",
                   "HALLMARK_OXIDATIVE_PHOSPHORYLATION",
                   "HALLMARK_MTORC1_SIGNALING",
                   "HALLMARK_G2M_CHECKPOINT",
                   "HALLMARK_E2F_TARGETS")

DSPathwayHeatmap(toplot_clusters[[1]], "Gene Set NES values for cytokine-metabolite associtations in T21", tolabel ="", DS_pathways = DS_pathways[c(1)])

```

Heatmap filtered by varying pathways

```{r data filtered by varying pathways}

varPathwaysHeatmap <- function(input, variance_filter  = 1.3, title, tolabel = "") {
  tokeep <- which(apply(input, 1, function(x) var(x) > variance_filter))
  input <- input %>%
     filter( rownames(input) %in% names(tokeep))
  names(input) <- gsub(" NES", "", names(input))
  
 
  column_labels <- ifelse(names(input) %in% tolabel, names(input), "")
  
  p1 <- Heatmap(
    as.matrix(input), 
    row_names_gp = gpar(fontsize = 7), 
    row_title = "",
    column_names_gp = gpar(fontsize = 7), 
    column_names_rot = 60,
    column_labels = column_labels,
    name = "NES", 
    column_title = title, 
    column_title_gp = gpar(fontsize = 12, fontface = "bold"),
    heatmap_legend_param = list(
      legend_direction = "vertical"), 
  )
  # pdf( "T21_pathway_heatmap.pdf")
   pdf(paste0("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/partial_correlation_results/figures/",title,"var_pathways_heatmap.pdf"), width = 12, height = 4)
  draw(p1,heatmap_legend_side="right")
  dev.off()
}

varPathwaysHeatmap(toplot_clusters[[1]], 1.5, "Gene Set NES values for cytokine-metabolite associtations in T21", tolabel = "")

```

## stratified heatmaps
```{r stratify gsea data}
T21_results <- full_results %>%
  filter(cluster == "T21")

T21_results_pos <- T21_results %>%
  filter(cor_cyt_met_r > 0)

cyt_met_pos <- c(paste(unique(T21_results_pos$cyt_met), "padj"), paste(unique(T21_results_pos$cyt_met), "NES"))


T21_results_neg <- T21_results %>%
  filter(cor_cyt_met_r < 0)

cyt_met_neg <- c(paste(unique(T21_results_neg$cyt_met), "padj"), paste(unique(T21_results_neg$cyt_met), "NES"))


```

```{r positive heatmaps}

toplot_pos <- toplot %>% 
  dplyr::select(which(names(toplot) %in% cyt_met_pos))

fullHeatmap(toplot_pos, "T21_pos")
varPathwaysHeatmap(toplot_pos, 1.5, "T21_pos")
```

```{r negative heatmaps}
toplot_neg <- toplot %>% 
  dplyr::select(which(names(toplot) %in% cyt_met_neg))

fullHeatmap(toplot_neg, "T21_neg")
varPathwaysHeatmap(toplot_neg, 1.5, "T21_neg")

```

## Trend figures

```{r trend figures}
library(ggplot2)
library(ggrepel)
trendPlot <- function(input, pathway, title ="", to_label) {
  
  if(pathway %in% rownames(input))  {
    tmp_toplot <- input %>%
        filter(rownames(input) == pathway) %>%
        t() %>%
        as.data.frame() %>%
        arrange(!!sym(pathway)) %>%
      rownames_to_column("cyt_met") %>%
      filter(!!sym(pathway) > 0) %>%
      mutate(rank = row_number()) %>%
      mutate(cyt_met = gsub(" NES", "", cyt_met))
      
    
    tmp_toplot$label <- ifelse(tmp_toplot$cyt_met %in% to_label, tmp_toplot$cyt_met, "")
  
    p1 <-  ggplot(tmp_toplot, aes_string(x = "rank", y = pathway, label = "label")) +
      geom_point() +
      geom_label_repel(max.overlaps = Inf, box.padding =.3, force = 30 ) + 
      theme_classic() +
      ggtitle(paste(title, pathway)) +
      xlab("Cytokine - Metabolite Associations") +
      ylab("NES")
    
     pdf(paste0("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/partial_correlation_results/figures/",title, "_", pathway, "trend.pdf"), height = 6, width = 10)
    print(p1)
    dev.off()
    
  } else {
    print(paste(pathway, "not in input data"))
  }
}



```

```{r trend plot wrapper}

pathways <- c("HALLMARK_INTERFERON_GAMMA_RESPONSE", 
                 "HALLMARK_INTERFERON_ALPHA_RESPONSE",
                 "HALLMARK_HEME_METABOLISM", 
                 "HALLMARK_INFLAMMATORY_RESPONSE",
                 "HALLMARK_OXIDATIVE_PHOSPHORYLATION",
                 "HALLMARK_MTORC1_SIGNALING",
                 "HALLMARK_G2M_CHECKPOINT",
                 "HALLMARK_E2F_TARGETS", 
                "HALLMARK_CHOLESTEROL_HOMEOSTASIS")
clusters <- c("T21", "D21", 1,2,3,4,5)

sapply(clusters[1], function(y) 
  sapply(pathways[c(1,3)], function(x) trendPlot(toplot_clusters[[y]], x, y, to_label = c("IFN-gamma-kynurenine", "IL-1RA-Cysteine", "IL-1RA-Glutamate")))
)

#sapply(pathways, function(x) trendPlot(toplot_neg, x, "T21_negative"))

```


```{r heatmaps over clusters}
#sapply(clusters, function(x) DSPathwayHeatmap(toplot_clusters[[x]], x))

sapply(clusters, function(x) varPathwaysHeatmap(toplot_clusters[[x]],2, x))
```


```{r trenplots clusters}
trendPlotclusters <- function(input_list, pathway, title ="", sd_thresh = 2.5) {
  
    T21_toplot_clusters <- input_list[[1]] %>%
        filter(rownames(input) == pathway) %>%
        t() %>%
        as.data.frame() %>%
        arrange(!!sym(pathway)) %>%
      rownames_to_column("cyt_met") %>%
      filter(!!sym(pathway) > 0) %>%
      mutate(rank = row_number())
      
    other_toplot_clusters <- lapply(2:7, function(x) {
       input_list[[x]] %>%
        filter(rownames(input) == pathway) %>%
        t() %>%
        as.data.frame() %>%
        rownames_to_column("cyt_met")%>%
        filter(cyt_met %in% T21_toplot_clusters$cyt_met) %>%
        mutate(normalized = !!sym(pathway) / T21_toplot_clusters[, pathway]) %>%
        dplyr::select(c(cyt_met, normalized))
        
    })
    
    other_toplot_clusters <-  other_toplot_clusters %>% reduce(left_join, by = "cyt_met" )
    names(other_toplot_clusters)[2:7] <- c("D21", 1,2,3,4,5)  
    other_toplot_clusters <- other_toplot_clusters %>%
      arrange(match(cyt_met, T21_toplot_clusters$cyt_met)) %>%
      mutate(rank = row_number())
    

    melted_toplot_clusters <- other_toplot_clusters %>%
      pivot_longer(cols = -c(cyt_met, rank), names_to = "cluster")
    
    melted_toplot_clusters$cluster <- as.factor(melted_toplot_clusters$cluster)
    
   melted_toplot_clusters$label <- ifelse(abs(melted_toplot_clusters$value) > (sd_thresh * sd(melted_toplot_clusters$value, na.rm = T)) , melted_toplot_clusters$cyt_met, "")   
  
    p1 <- ggplot(melted_toplot_clusters, aes_string(x = "rank", y = "value", color = "cluster", label = "label")) +
      geom_point(alpha = .7) +
      geom_label_repel(max.overlaps = Inf, box.padding =.5, force = 40, size =3 ) + 
      theme_classic() +
      ggtitle(paste(title, pathway)) +
      xlab("Cytokine - Metabolite Associations") +
      ylab("NES")
   pdf(paste0("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/partial_correlation_results/figures/",title, "_", pathway, "trend_all_clusters.pdf"), height = 6, width = 10)
     print(p1)
    dev.off()

}

```

```{r}

pathways <- c("HALLMARK_INTERFERON_GAMMA_RESPONSE", 
                 "HALLMARK_INTERFERON_ALPHA_RESPONSE",
                 "HALLMARK_HEME_METABOLISM", 
                 "HALLMARK_INFLAMMATORY_RESPONSE",
                 "HALLMARK_OXIDATIVE_PHOSPHORYLATION",
                 "HALLMARK_MTORC1_SIGNALING",
                 "HALLMARK_G2M_CHECKPOINT",
                 "HALLMARK_E2F_TARGETS", 
                "HALLMARK_CHOLESTEROL_HOMEOSTASIS")



sapply(pathways, function(x) trendPlotclusters(toplot_clusters, x, "all", sd_thresh = 2.8))



```

```{r density plots of specific relationships and pathway leading edge genes}
leadingEdgeDensity <- function(cyt_met_example, key_pathways) {
 
  cluster = "T21"
  
  clusters <- c("T21", "D21", 1,2,3,4,5)
  
  cyt_met_labels <- names(gsea_results_formatted[[1]]) 
  cyt_met_labels <- cyt_met_labels[grepl("NES", cyt_met_labels)]
  
  path_id <- which(cyt_met_labels == cyt_met_example)
  
  tmp_gsea <- gsea_results[[which(cluster == clusters)]][[path_id]]
  
  leadingEdge1 <- tmp_gsea %>%
    filter(pathway == key_pathways[1]) %>%
    dplyr::select(leadingEdge) %>%
    .$leadingEdge
  leadingEdge1 <- leadingEdge1[[1]]
  
  
  leadingEdge2 <- tmp_gsea %>%
    filter(pathway == key_pathways[2]) %>%
    dplyr::select(leadingEdge) %>%
    .$leadingEdge
  leadingEdge2 <- leadingEdge2[[1]]
  
  
  
  
  single_rel_z <- long_z[[1]] %>%
    filter(cyt_met == gsub(" NES", "",cyt_met_example)) %>%
    as.data.frame() %>%
    arrange(-combined_Z) 
  
  lines <- data.frame(
    intercepts =c(single_rel_z[single_rel_z$gene %in% leadingEdge1,"combined_Z"], single_rel_z[single_rel_z$gene %in% leadingEdge2,"combined_Z"]),
    names = c(rep(key_pathways[1],length(leadingEdge1)), rep(key_pathways[2], length(leadingEdge2)))
)
  

  
  
  p1 <- ggplot(single_rel_z, aes(x = combined_Z)) +
    geom_density()+
    geom_vline(data = lines, aes(xintercept = intercepts, color = names)) +
    scale_color_manual(name = "Pathway Gene Set", values = c( 'purple', 'red'))+
    ggtitle(cyt_met_example) + 
    theme_classic() +
    xlab("combined_Z") +
    theme(legend.position = "bottom")
  
  
  
  ggsave(plot = p1, 
         filename = paste0("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/partial_correlation_results/figures/",cluster, "_", cyt_met_example,"_", key_pathways[1], "_", key_pathways[2],"_", "leading_edge_density.pdf"),
          device = "pdf", height = 6, width = 10)
}

leadingEdgeDensity( cyt_met_example ="IL-1RA-Glutamate NES",  key_pathways = c("HALLMARK_HEME_METABOLISM", "HALLMARK_INTERFERON_GAMMA_RESPONSE"))
leadingEdgeDensity( cyt_met_example ="IL-1RA-Glutamate NES",  key_pathways = c("HALLMARK_HEME_METABOLISM", "HALLMARK_KRAS_SIGNALING_DN"))
leadingEdgeDensity( cyt_met_example ="IL-1RA-Glutamate NES",  key_pathways = c("HALLMARK_HEME_METABOLISM", "HALLMARK_MYC_TARGETS_V2"))
 leadingEdgeDensity( cyt_met_example ="IFN-gamma-kynurenine NES",  key_pathways = c("HALLMARK_HEME_METABOLISM", "HALLMARK_INTERFERON_GAMMA_RESPONSE"))
 leadingEdgeDensity( cyt_met_example ="IL-1RA-Cysteine NES",  key_pathways = c("HALLMARK_HEME_METABOLISM", "HALLMARK_INTERFERON_GAMMA_RESPONSE"))

```

```{r gene annotation}
library(biomaRt)
ensembl <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")
 listAttributes(ensembl)
listFilters(ensembl)
myFilters <- "external_gene_name"
myAttributes <- c("external_gene_name","description","name_1006", "namespace_1003")
res <- getBM(mart = ensembl, 
             attributes = myAttributes, 
             filters = myFilters,
             values = head(single_rel_z$gene, 100))



res$TF <- ifelse(res$external_gene_name %in% transcription_factors$V1, "yes", "no")
res$enzyme <- ifelse(grepl("ase|enz", res$description), "yes", "no")
res$transporter <- ifelse(grepl("transp", res$name_1006), "yes", "no")
res$pathway <- ifelse(res$external_gene_name %in% leadingEdge, "yes", "no")

res <- res %>%
  arrange(desc(TF), desc(enzyme), desc(transporter)) %>%
  distinct(description, .keep_all = T) %>%
   arrange(match(external_gene_name, head(single_rel_z$gene,100))) %>%
  dplyr::select(-namespace_1003)



write.csv(res, file = paste0("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/partial_correlation_results/gene_annotation/", cluster, "_", key_pathway, "_", cyt_met_example, ".csv"))
```


```{r gsea stats reporting out}

cyt_met_rels <- names(gsea_results_formatted[[1]])[grepl("NES", names(gsea_results_formatted[[1]]))]
which(grepl("IL-1RA-Cysteine", cyt_met_rels))

gsea_results[[1]][[119]] %>% arrange(-NES)
  

```

```{r differential expression heatmap}
library(ComplexHeatmap)
library(circlize)
gsea_results_diff_formatted <- lapply(gsea_results_diff, function(y) {
     y %>% dplyr::select(pathway, NES,padj)
 
 })
gsea_results_diff_formatted[[1]]$NES <- gsea_results_diff_formatted[[1]]$NES * -1
gsea_results_diff_formatted <- lapply(gsea_results_diff_formatted, bind_cols)

gsea_results_diff_formatted <- gsea_results_diff_formatted %>% reduce(left_join,by = "pathway")

names(gsea_results_diff_formatted) <- c("pathway",
                                        "T21 NES", "T21 padj",
                                        "1 NES", "1 padj",
                                        "2 NES", "2 padj",
                                        "3 NES", "3 padj",
                                        "4 NES", "4 padj",
                                        "5 NES", "5 padj")

diff_expr_toplot <- gsea_results_diff_formatted %>%
  column_to_rownames("pathway") %>%
  dplyr::select(contains("NES"))

 DS_pathways <- c("HALLMARK_INTERFERON_GAMMA_RESPONSE", 
                   "HALLMARK_INTERFERON_ALPHA_RESPONSE",
                   "HALLMARK_HEME_METABOLISM", 
                   "HALLMARK_INFLAMMATORY_RESPONSE",
                   "HALLMARK_OXIDATIVE_PHOSPHORYLATION",
                   "HALLMARK_MTORC1_SIGNALING",
                   "HALLMARK_G2M_CHECKPOINT",
                   "HALLMARK_E2F_TARGETS")


  input <- diff_expr_toplot %>%
    dplyr::filter(rownames(diff_expr_toplot) %in% DS_pathways[c(1,3)])
  
  rownames(input) <- gsub("HALLMARK", "", rownames(input))
  rownames(input) <- gsub("_"," ", rownames(input))
  names(input) <- c("T21", "Cluster 1", "Cluster 2", "Cluster 3", "Cluster 4", "Cluster 5")
  col_fun = colorRamp2(c(min(input),0, max(input) ), c("purple","white", "yellow"))
  p1 <- Heatmap(
    t(input), 
    row_names_gp = gpar(fontsize = 10), 
    row_dend_reorder = FALSE,
    column_dend_reorder = FALSE,
    show_row_dend = FALSE, 
    show_column_dend = FALSE,
    col = col_fun,
    row_order = c("T21", "Cluster 1", "Cluster 2", "Cluster 3", "Cluster 4", "Cluster 5"),
    row_title = "",
    column_names_gp = gpar(fontsize = 10), 
    column_names_rot = 90,
    show_column_names = TRUE,
    name = "NES", 
    column_title = "Pathway Enrichment of \n Differential Expression  by \n Karyotype or Across Clusters", 
    column_title_gp = gpar(fontsize = 12, fontface = "bold"),
    heatmap_legend_param = list(
      legend_direction = "horizontal"), 
  )
  # pdf( "T21_pathway_heatmap.pdf")
pdf(file = "~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/partial_correlation_results/figures/differential_expression_DS_pathways_heatmap.pdf", width = 2.5, height = 12)
draw(p1,heatmap_legend_side="bottom")
dev.off()





```


```{r qqplots}



qqplot <- function(pathway, cluster1,cluster2) {
  tmp_gsea <- lapply(gsea_results_formatted, function(x) {
    x %>% dplyr::select(contains("padj")) %>% filter(rownames(x) == pathway)
  })
  
  for(x in 2:7) {
    names(tmp_gsea[[x]]) <- names(tmp_gsea[[1]])
  }
  
  tmp_data1 <- t(tmp_gsea[[which(clusters == cluster1)]]) %>% as.data.frame
  tmp_data2 <- t(tmp_gsea[[which(clusters == cluster2)]]) %>% as.data.frame
  tmp_data <- cbind(tmp_data1, tmp_data2)
  names(tmp_data) <- c(paste0("cluster","_", cluster1),paste0("cluster","_", cluster2))
  tmp_data <- tmp_data %>%
    filter(!is.na(tmp_data[,1]) & !is.na(tmp_data[,2]))
  tmp_data <- -log10(tmp_data)
  
  tmp_data$label <- ifelse(tmp_data[,1] %in% tmp_data[,1][order(tmp_data[,1], decreasing = TRUE)[1:5]] |tmp_data[,2] %in% tmp_data[,2][order(tmp_data[,2], decreasing = TRUE)[1:5]], rownames(tmp_data), "")
  
  p1 <- ggplot(tmp_data, aes_string(x = paste0("cluster","_", cluster1), y = paste0("cluster","_",cluster2), label = "label")) +
    geom_point() +
    geom_label_repel(max.overlaps = Inf, box.padding =1.5, force = 30 )+
    theme_classic()+
    xlab( paste0("-log10 pathway FDR cluster", cluster1))+
    ylab( paste0("-log10 pathway FDR cluster", cluster2)) +
    ggtitle(pathway)
   
  ggsave(plot = p1, 
         filename = paste0("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/partial_correlation_results/figures/qqplot", "_", pathway,"_", cluster1, "_", cluster2,".pdf"),
          device = "pdf", height = 6, width = 10)
  
}  

qqplot(pathways[1], "T21", "5")
qqplot(pathways[3], "3","5")
qqplot(pathways[3], "T21","3")
qqplot(pathways[3], "T21", "5")

```


```{r qqplot zscore}
library(fgsea)
library(gridExtra)
library(ggpubr)
library(ggrepel)

clusters <- c("T21", "D21", 1,2,3,4,5)
names(full_z_results) <- clusters
cyt_met_example <- "IFN-gamma-kynurenine"
key_pathway <- "HALLMARK_INTERFERON_GAMMA_RESPONSE"
chr21_genes <- read_tsv( file = "~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/data/protein-coding_gene_chr_21.txt")
chr21_genes <- chr21_genes$symbol
names(gsea_results) <- clusters
pathways_all <- gmtPathways("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/data/pathway/h.all.v2023.1.Hs.symbols.gmt")



qqplotZscore <- function(cyt_met_example, cluster1,cluster2,key_pathway, sd_multiplier = 5) {
  
  pathway_genes <- pathways_all[key_pathway][[1]]
  
  tmp_z <- lapply(full_z_results ,function(x){
    x %>% as.data.frame %>%dplyr::select(cyt_met_example)
  })

  tmp_data <- cbind(tmp_z[[which(names(tmp_z) == cluster1)]], tmp_z[[which(names(tmp_z) == cluster2)]])
  names(tmp_data) <- c(paste0("cluster","_", cluster1),paste0("cluster","_", cluster2))
 
    
  tmp_data$diff <- tmp_data[,1]-tmp_data[,2]
  
  tmp_data <-tmp_data %>% arrange(-diff)
  
  
 # if(any("T21" %in% c(cluster1,cluster2))){
    tmp_diff <- diff_genes[[1]]
    tmp_diff$logFC <- tmp_diff$logFC *-1
    diff_genes_vec <- tmp_diff %>%
      filter(adj.P.Val < .1 & logFC > 0) %>%
      rownames()

  # # } else {
  #    tmp_diff1 <- diff_genes[[which(names(diff_genes) == cluster1)]]
  #    diff_genes_vec1 <- tmp_diff1 %>%
  #     filter(adj.P.Val < .1 & logFC > 0) %>%
  #     rownames()
  # 
  #     tmp_diff2 <- diff_genes[[which(names(diff_genes) == cluster2)]]
  #    diff_genes_vec2 <- tmp_diff2 %>%
  #     filter(adj.P.Val < .1 & logFC > 0) %>%
  #     rownames()
  # 
  #    diff_genes_vec <- union(diff_genes_vec1,diff_genes_vec2)
  # }

  
  key_DEG <- paste0(key_pathway, "_DEG")
  key_DEG_chr21 <-  paste0(key_pathway, "_DEG_CHR21")
  key_chr21 <- paste0(key_pathway, "_CHR21")
  
  tmp_data$pathway <- ifelse(rownames(tmp_data) %in% intersect(pathway_genes, intersect(diff_genes_vec,chr21_genes)), key_DEG_chr21, 
                             ifelse(rownames(tmp_data) %in% intersect(pathway_genes, chr21_genes),key_chr21,
                                    ifelse(rownames(tmp_data) %in% intersect(pathway_genes, diff_genes_vec),key_DEG, 
                                           ifelse(rownames(tmp_data) %in% pathway_genes, key_pathway, "no_label"))))
  
  tmp_data$label <- ifelse((tmp_data$pathway != "no_label" & abs(tmp_data$diff) > sd_multiplier*sd(tmp_data$diff))  , rownames(tmp_data), "")
  
  cols <- c("gray", "black", "green3","black", "black")
  col_names <- c("no_label", key_pathway, key_DEG, key_DEG_chr21, key_chr21)
  col_vec <- setNames(cols,col_names)
  alphas <- c(0.1,1,1,1,1)
  alpha_vec <- setNames(alphas,col_names)
  
  limit <- max(abs(max(tmp_data[,1:2])), abs(min(tmp_data[,1:2])))
  neg_limit <- limit*-1
      
 p1 <- ggplot(tmp_data, aes_string(x = paste0("cluster","_", cluster1), y = paste0("cluster","_",cluster2), color = "pathway", alpha = "pathway", label = "label")) +
    geom_point() +
    geom_label_repel(max.overlaps = Inf, box.padding =1.5, force = 30 )+
    theme_classic() +
    scale_color_manual(values = col_vec) +
    scale_alpha_manual(values =alpha_vec)+
   theme(legend.position = "none") +
   ggtitle(paste(cluster1,"  ",  cluster2,"  " ,cyt_met_example,"  ", key_pathway)) +
   guides(color = guide_legend(nrow = 2))+
   xlim(c(neg_limit,limit))+
   ylim(c(neg_limit,limit))+
   xlab(paste0(cluster1, " Z scores")) +
   ylab(paste0(cluster2, " Z scores"))
 
 p2 <- ggplot(tmp_data,aes_string(x = paste0("cluster","_", cluster1))) + 
   geom_density(fill = "darkgoldenrod") + 
    xlim(c(neg_limit,limit))+
   ylim(c(neg_limit,limit))+
   theme_void() 
 
 # +
 #   xlab("") +
 #   ylab("") +
 #   theme(axis.text.x=element_blank(),
 #      axis.ticks.x=element_blank(),
 #      axis.text.y=element_blank(),
 #      axis.ticks.y=element_blank())
 
  p3 <- ggplot(tmp_data,aes_string(x = paste0("cluster","_", cluster2))) + 
   geom_density(fill = "darkorchid4" ) + 
   theme_void() +
     xlim(c(neg_limit,limit))+
   ylim(c(neg_limit,limit))+
    coord_flip()
  
  # +
  #   coord_flip()  +
  #  xlab("") +
  #  ylab("") +
  #  theme(axis.text.x=element_blank(),
  #     axis.ticks.x=element_blank(),
  #     axis.text.y=element_blank(),
  #     axis.ticks.y=element_blank())
  
  
  
# full_plot = grid.arrange(grobs = list(p2,p1,p3),  layout_matrix = rbind(c(1,NA), c(2,3)), widths = c(10,2), heights = c(2,10))
  full_plot = p1
   
  ggsave(plot = full_plot, 
         filename = paste0("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/partial_correlation_results/figures/z_score_qqplot", "_",cyt_met_example,"_", key_pathway,"_", cluster1, "_", cluster2,".pdf"),
          device = "pdf", height = 10, width = 10)
  
}  

 qqplotZscore(cyt_met_example = "IFN-gamma-kynurenine", cluster1 = "T21", cluster2 = "D21", key_pathway = "HALLMARK_INTERFERON_GAMMA_RESPONSE", sd_multiplier = 4)
# 
 qqplotZscore(cyt_met_example = "IL-1RA-Glutamate", cluster1 = "T21", cluster2 = "D21", key_pathway = "HALLMARK_HEME_METABOLISM", sd_multiplier = 4)
# 
# # 
 # qqplotZscore(cyt_met_example = "IFN-gamma-kynurenine", cluster1 = "2", cluster2 = "3", key_pathway = "HALLMARK_INTERFERON_GAMMA_RESPONSE", sd_multiplier = 5)
 #qqplotZscore(cyt_met_example = "IFN-gamma-kynurenine", cluster1 = "2", cluster2 = "T21", key_pathway = "HALLMARK_INTERFERON_GAMMA_RESPONSE", sd_multiplier = 4)
# qqplotZscore(cyt_met_example = "IFN-gamma-kynurenine", cluster1 = "5", cluster2 = "3", key_pathway = "HALLMARK_INTERFERON_GAMMA_RESPONSE", sd_multiplier = 3)
# # 
# # 
# # qqplotZscore(cyt_met_example = "IL-1RA-Glutamate", cluster1 = "T21", cluster2 = "3", key_pathway = "HALLMARK_HEME_METABOLISM")
# #qqplotZscore(cyt_met_example = "IL-1RA-Glutamate", cluster1 = "4", cluster2 = "3", key_pathway = "HALLMARK_HEME_METABOLISM", sd_multiplier = 3)
# 
# qqplotZscore(cyt_met_example = "IL-1RA-Glutamate", cluster1 = "4", cluster2 = "5", key_pathway = "HALLMARK_HEME_METABOLISM", sd_multiplier = 4)


# qqplotZscore(cyt_met_example = "VCAM-1-acyl-C12 (O-dodecanoyl-carnitine)", cluster1 = "T21", cluster2 = "D21", key_pathway = "HALLMARK_HEME_METABOLISM")
 
#  qqplotZscore(cyt_met_example = "VCAM-1-acyl-C12 (O-dodecanoyl-carnitine)", cluster1 = "5", cluster2 = "3", key_pathway = "HALLMARK_HEME_METABOLISM")
 
 #qqplotZscore(cyt_met_example = "IL-29-Docosapentaenoic acid", cluster1 = "T21", cluster2 = "D21", key_pathway = "HALLMARK_INTERFERON_GAMMA_RESPONSE")
 #qqplotZscore(cyt_met_example = "IL-29-Docosapentaenoic acid", cluster1 = "T21", cluster2 = "D21", key_pathway = "HALLMARK_HEME_METABOLISM") 
 
# qqplotZscore(cyt_met_example = "CRP-Succinate", cluster1 = "T21", cluster2 = "3", key_pathway = "HALLMARK_HEME_METABOLISM")
# qqplotZscore(cyt_met_example = "CRP-Succinate", cluster1 = "3", cluster2 = "T21", key_pathway = "HALLMARK_HEME_METABOLISM")
# qqplotZscore(cyt_met_example = "CRP-Serine", cluster1 = "T21", cluster2 = "3", key_pathway = "HALLMARK_HEME_METABOLISM")
# qqplotZscore(cyt_met_example = "CRP-Serine", cluster1 = "3", cluster2 = "T21", key_pathway = "HALLMARK_HEME_METABOLISM")
# qqplotZscore(cyt_met_example = "CRP-Serine", cluster1 = "5", cluster2 = "T21", key_pathway = "HALLMARK_HEME_METABOLISM")
```

```{r heatmap of cyt_met across clusters}
DS_pathways <- c("HALLMARK_INTERFERON_GAMMA_RESPONSE", 
                 "HALLMARK_INTERFERON_ALPHA_RESPONSE",
                 "HALLMARK_HEME_METABOLISM", 
                 "HALLMARK_INFLAMMATORY_RESPONSE",
                 "HALLMARK_OXIDATIVE_PHOSPHORYLATION",
                 "HALLMARK_MTORC1_SIGNALING",
                 "HALLMARK_G2M_CHECKPOINT",
                 "HALLMARK_E2F_TARGETS", 
                "HALLMARK_CHOLESTEROL_HOMEOSTASIS")


ClusterPathwayHeatmap <- function(input, cyt_met_example,  key_pathways) {
  
    tmp_input <- lapply(input, function(x) {
      x  %>%
        dplyr::filter(rownames(x) %in% key_pathways) %>% 
        dplyr::select(contains(cyt_met_example))
        
  })
    
  tmp_input <-  bind_cols(tmp_input)
  names(tmp_input) <- clusters
 
  
  rownames(tmp_input) <- gsub("HALLMARK_","", rownames(tmp_input))
  rownames(tmp_input) <- gsub("_"," ", rownames(tmp_input))
  
  
  col_fun = colorRamp2(c(min(tmp_input),0, max(tmp_input) ), c("white","gray", "red"))
  
  p1 <- Heatmap(
    as.matrix(tmp_input), 
    row_names_gp = gpar(fontsize = 10), 
    row_title_side = "left",
    column_names_gp = gpar(fontsize = 10), 
    column_names_rot = 0,
    row_dend_reorder = FALSE, 
    column_order = clusters,
    column_dend_reorder = FALSE, 
    show_row_dend = FALSE, 
    show_column_dend = FALSE,
    name = "NES", 
    column_title = paste(cyt_met_example), 
    column_title_gp = gpar(fontsize = 12, fontface = "bold"),
    heatmap_legend_param = list(
      legend_direction = "horizontal"),
    col = col_fun
    
  )
  # pdf( "T21_pathway_heatmap.pdf")
   pdf(paste0("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/partial_correlation_results/figures/",cyt_met_example, "_", "_cluster_heatmap.pdf"), width = 10, height = 4)
  draw(p1,heatmap_legend_side="bottom")
  dev.off()
} 


ClusterPathwayHeatmap(toplot_clusters,"IFN-gamma-kynurenine", DS_pathways[c(1,3)])
ClusterPathwayHeatmap(toplot_clusters,"IL-1RA-Glutamate", DS_pathways[c(1,3)])
```




### mediation signatures

```{r}
library(tidyverse)
input <- toplot_clusters[[1]]
key_pathway <- "HALLMARK_INTERFERON_GAMMA_RESPONSE"

mediationSignatures <- function(key_pathway) {
  
  tmp_input <-  gsea_results_formatted[[1]] %>%                                              
    filter(rownames(toplot_clusters[[1]]) == key_pathway) %>%
    rownames_to_column("pathway") %>%
    pivot_longer(cols = contains("NES"), values_to = "NES", names_to = "cyt_met_NES") %>%
    pivot_longer(cols = contains("padj"), values_to = "padj", names_to = "cyt_met_padj") %>% 
    filter(gsub(" NES", "", cyt_met_NES) == gsub(" padj", "", cyt_met_padj)) %>%
    mutate(cyt_met = gsub(" NES", "", cyt_met_NES)) %>%
    select(pathway, cyt_met, NES, padj) %>%
    filter(padj < .1 & NES > 0 & pathway == key_pathway) %>%
    arrange(padj)
  
  signature <- tmp_input$cyt_met
  
  return(signature)
  
} 

  
library(fgsea)
pathways_all <- gmtPathways("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/data/pathway/h.all.v2023.1.Hs.symbols.gmt")
pathways <- names(pathways_all)

mediation_signatures <- lapply(pathways, mediationSignatures )
names(mediation_signatures) <- pathways
mediation_signatures[sapply(mediation_signatures, function(x) length(x) ==0)] <- NULL

```

#### Venn Diagram of mediation signatures 
```{r}

DS_pathways <- c("HALLMARK_INTERFERON_GAMMA_RESPONSE", 
                 "HALLMARK_HEME_METABOLISM", 
                 "HALLMARK_OXIDATIVE_PHOSPHORYLATION", 
                 )

if (!require(devtools)) install.packages("devtools")
devtools::install_github("yanlinlin82/ggvenn")

library(ggvenn)

x <- mediation_signatures[DS_pathways]
names(x) <- gsub("HALLMARK_", "", names(x))

venn <- ggvenn(
  x, 
  fill_color = c("#0073C2FF", "#EFC000FF", "#868686FF", "#CD534CFF"),
  stroke_size = 0.5, set_name_size = 3
  )


ggsave(filename = "~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/partial_correlation_results/figures/mediation_signatures_venn.pdf", width = 10, height =5, units ="in")

```

#### Find the clusters where the cytokine-metabolite relationships differ most by the mediation signatures
```{r}
library(openxlsx)

### list of T21 correlated cytokine metabolites

T21_corr = read.xlsx("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/tables/cluster_correlations_D21.xlsx")
T21_corr <- T21_corr %>%
  mutate(cyt_met = paste0(source,"-", target))

cluster <- "Cluster3"
key_pathway <- "HALLMARK_HEME_METABOLISM"


cyt_met <- names(gsea_results_formatted[[1]])
cyt_met <- gsub(" NES| padj", "", cyt_met)
cyt_met <- cyt_met[!duplicated(cyt_met)]

signatureEnrichment <- function(cluster, key_pathway) {

  tmp_corr <- T21_corr %>%
    select(c(cyt_met, All_p, All_r, contains(cluster))) %>%
    filter(!(is.na(!!sym(paste0(cluster, "_p"))))) %>%
    filter(cyt_met %in% cyt_met) %>%
    mutate(diff = !!sym(paste0(cluster, "_r")) - All_r) %>%
    filter(!is.na(diff))
  
  
  pathway_overlap <- intersect(tmp_corr$cyt_met, mediation_signatures[[key_pathway]])
  corr_non_overlap <-tmp_corr$cyt_met[!(tmp_corr$cyt_met %in% pathway_overlap)]
  signature_non_overlap <- mediation_signatures[[key_pathway]][!(mediation_signatures[[key_pathway]] %in% pathway_overlap)]
  non_non <- cyt_met[!(cyt_met %in% union(pathway_overlap,union(corr_non_overlap,signature_non_overlap)))]
  
  
  totest <- matrix(c(length(pathway_overlap),length(corr_non_overlap),length(signature_non_overlap),length(non_non)), nrow = 2, ncol =2)
  
  
  res <- fisher.test(totest)
  pval <- res$p.value
  or <- res$estimate
  
  pathway_result <- as.data.frame(matrix(c(cluster, key_pathway, or, pval), nrow =1 ))
  return(pathway_result) 
}


signatureWrapper <- function(cluster) {
  res <- lapply(pathways, function(x) {
    signatureEnrichment(cluster,x)
  })
  res <- bind_rows(res)
  names(res) <- c("Cluster", "Pathway", "OR", "p")
  res$adjp <- p.adjust(res$p,method = "fdr")
  res <- res %>% 
    arrange(adjp)
  return(res)
}

clusters <- c("Cluster1", "Cluster2", "Cluster3", "Cluster4", "Cluster5")

signature_enrichment <- lapply(clusters, function(x) {
  signatureWrapper(x)  
})




```



#### Scatter plots in the clusters by the mediation signatures
```{r}
library(openxlsx)
library(ggplot2)
library(gridExtra)

### list of T21 correlated cytokine metabolites

# T21_corr = read.xlsx("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/tables/cluster_correlations_D21.xlsx")
# T21_corr <- T21_corr %>%
#   mutate(cyt_met = paste0(source,"-", target))

key_cluster <- 5
key_pathway <- "HALLMARK_HEME_METABOLISM"
key_rel <- "IFN-gamma-kynurenine"


cyt_met <- names(gsea_results_formatted[[1]])
cyt_met <- gsub(" NES| padj", "", cyt_met)
cyt_met <- cyt_met[!duplicated(cyt_met)]

signaturePlot <- function(key_pathway) {

  tmp_corr <- full_results %>%
#    filter(cluster %in% c("T21", key_cluster)) %>%
    select(cyt_met, cluster, cor_cyt_met_r, cor_cyt_met_p) %>%
    distinct(cyt_met,cluster, .keep_all = TRUE) %>%
    pivot_wider(names_from = cluster, values_from = c(cor_cyt_met_r, cor_cyt_met_p))%>%
    mutate(pathway = ifelse(cyt_met %in% mediation_signatures[[key_pathway]], key_pathway, 0))
  
  alphas <- c(1,.5)
  alpha_vec <- setNames(alphas,c(key_pathway,0))
  colors <- c( "black", "gray")
  color_vec <- setNames(colors, c(key_pathway,0))
  
   p <- ggplot(tmp_corr, aes_string(x = paste0("cor_cyt_met_r_D21"), y= "cor_cyt_met_r_T21", color = "pathway", alpha = "pathway")) +
    geom_point() +
    scale_alpha_manual(values = alpha_vec)+
      scale_color_manual(values = color_vec)+
    xlim(c(-.8,.8))+
    ylim(c(-.8,.8)) +
    geom_abline(linetype = "dashed", color = "gray") +
    ggtitle(key_pathway) +
    xlab(paste("D21 cyt-met r")) +
    ylab("T21 cyt-met r") +
    theme_classic() +
    theme(legend.position = "none")
  
  p1 <- ggplot(tmp_corr, aes_string(x = paste0("cor_cyt_met_r_",1), y= "cor_cyt_met_r_T21", color = "pathway", alpha = "pathway")) +
    geom_point() +
    scale_alpha_manual(values = alpha_vec)+
      scale_color_manual(values = color_vec)+
    xlim(c(-.8,.8))+
    ylim(c(-.8,.8)) +
    geom_abline(linetype = "dashed", color = "gray") +
    ggtitle(key_pathway) +
    xlab(paste("Cluster",1, "cyt-met r")) +
    ylab("T21 cyt-met r") +
    theme_classic() +
    theme(legend.position = "none")
   
   p2 <- ggplot(tmp_corr, aes_string(x = paste0("cor_cyt_met_r_",2), y= "cor_cyt_met_r_T21", color = "pathway", alpha = "pathway")) +
    geom_point() +
    scale_alpha_manual(values = alpha_vec)+
      scale_color_manual(values = color_vec)+
    xlim(c(-.8,.8))+
    ylim(c(-.8,.8)) +
    geom_abline(linetype = "dashed", color = "gray") +
    ggtitle(key_pathway) +
    xlab(paste("Cluster",2, "cyt-met r")) +
    ylab("T21 cyt-met r") +
    theme_classic() +
    theme(legend.position = "none")
   
     p3 <- ggplot(tmp_corr, aes_string(x = paste0("cor_cyt_met_r_",3), y= "cor_cyt_met_r_T21", color = "pathway", alpha = "pathway")) +
    geom_point() +
    scale_alpha_manual(values = alpha_vec)+
      scale_color_manual(values = color_vec)+
    xlim(c(-.8,.8))+
    ylim(c(-.8,.8)) +
    geom_abline(linetype = "dashed", color = "gray") +
    ggtitle(key_pathway) +
    xlab(paste("Cluster",3, "cyt-met r")) +
    ylab("T21 cyt-met r") +
    theme_classic() +
    theme(legend.position = "none")
     
       p4 <- ggplot(tmp_corr, aes_string(x = paste0("cor_cyt_met_r_",4), y= "cor_cyt_met_r_T21", color = "pathway", alpha = "pathway")) +
    geom_point() +
    scale_alpha_manual(values = alpha_vec)+
      scale_color_manual(values = color_vec)+
    xlim(c(-.8,.8))+
    ylim(c(-.8,.8)) +
    geom_abline(linetype = "dashed", color = "gray") +
    ggtitle(key_pathway) +
    xlab(paste("Cluster",4, "cyt-met r")) +
    ylab("T21 cyt-met r") +
    theme_classic() +
    theme(legend.position = "none")
       
         p5 <- ggplot(tmp_corr, aes_string(x = paste0("cor_cyt_met_r_",5), y= "cor_cyt_met_r_T21", color = "pathway", alpha = "pathway")) +
    geom_point() +
    scale_alpha_manual(values = alpha_vec)+
      scale_color_manual(values = color_vec)+
    xlim(c(-.8,.8))+
    ylim(c(-.8,.8)) +
    geom_abline(linetype = "dashed", color = "gray") +
    ggtitle(key_pathway) +
    xlab(paste("Cluster", 5, "cyt-met r")) +
    ylab("T21 cyt-met r") +
    theme_classic() +
    theme(legend.position = "none")
 
  
 p_all <- grid.arrange(p,p1,p2,p3,p4,p5, nrow = 1)

 return(p_all)
         
          
}

 plots <-lapply(names(mediation_signatures),function(x) signaturePlot(x))
 g <- marrangeGrob(plots, nrow = 6, ncol = 1)
 
  ggsave(filename = paste0("~/OneDrive - The University of Colorado Denver/Projects/subPhenoDS/results/partial_correlation_results/figures/T21_vs_cluster_mediation_signatures.pdf"), g,height = 25,width = 25, units = "in") 


 

```

#### Scatter plots for individual Clusters
```{r}
library(umap)

T21_gsea <- gsea_results_formatted[[1]] %>%
  select(contains("NES")) %>%
  t()

which_na <- apply(T21_gsea, 1, function(x) !(any(is.na(x))))

T21_gsea <- T21_gsea[which_na,]

NES_umap <- umap(T21_gsea)

tmp <- NES_umap$layout %>%
  as.data.frame() %>%
  rownames_to_column("cyt_met") %>%
   mutate(pathway = ifelse(cyt_met %in% mediation_signatures[[key_pathway]], key_pathway, 0))

 alphas <- c(1,.5)
  alpha_vec <- setNames(alphas,c(key_pathway,0))
  colors <- c( "black", "gray")
  color_vec <- setNames(colors, c(key_pathway,0))
  

  p1 <- ggplot(tmp, aes_string(x = "V1", y= "V2", color = "pathway", alpha = "pathway")) +
    geom_point() +
    scale_alpha_manual(values = alpha_vec)+
      scale_color_manual(values = color_vec)
  
 



### Utilizing Knowledge Graph embeddings to identify potential causal mediators. 
A knowledge graph is a network representations of associations between entities. Using these graph as a base we can perform symbolic reasoning over the graph to identify key players within a multitude of different pathways. 

Approach:
* Inputs:
  * list of tuples  <cytokine, gene, metaboite> with evidence for mediation via partial correlation
  * Pheknowlator embeddings calculated with node2vec
* Outputs:
  * Ranked list of genes for tuples
* Approach:
  * Find the average cosine similarity betwee

```{r}
library(data.table)
kg_embeddings <- fread("~/OneDrive - The University of Colorado Denver/Projects/Cartoomics/pfocr_tests/pkl/PheKnowLator_v3_node2vec_Embeddings128.emb", skip = 1, sep = " ", header = FALSE)
id_map <- read.delim("~/OneDrive - The University of Colorado Denver/Projects/Cartoomics/pfocr_tests/pkl/PheKnowLator_v3.0.2_full_instance_relationsOnly_OWLNETS_NodeLabels.txt")


IDO1_id <- id_map %>% filter(grepl("indoleamine", label )) %>% select(label, integer_id)
IDO1_id <- IDO1_id[3,]
kynurenine_id <- id_map %>% filter(grepl("kynurenine", label )) %>%  select(label, integer_id)
kynurenine_id <- kynurenine_id[3,c("label", "integer_id")]
IDO1_id <- id_map %>% filter(grepl("indoleamine", label ))
IDO1_id <- IDO1_id[3,c("label", "integer_id")]

  
kg_embeddings %>% filter(V1 == 29524)
```


### normalize to mediation in D21
```{r}

D21_normed <- lapply(c(1,3:7),  function(x) {
  long_z[[x]]$norm_z <- (long_z[[x]]$combined_Z - long_z[[2]]$combined_Z)/ long_z[[2]]$combined_Z
  return(long_z[[x]])
})


D21_normed[[1]] <- D21_normed[[1]] %>%
  arrange(-norm_z)

head(D21_normed[[1]])

ggplot(D21_normed[[1]], aes(x = as.factor(cyt_met), y = norm_z)) +
  geom_point(size = .5) +
  theme(axis.text.x = element_text())

```


  
