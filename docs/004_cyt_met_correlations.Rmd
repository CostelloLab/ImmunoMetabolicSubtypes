#### This is a program for calculating the spearman correlations between cytokine and metabolite abundances.

### load the libraries

```{r}
### load the libraries
library(tidyverse)
library(ComplexHeatmap)
library(circlize)
library(psych)
source("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/R/cyt_met_correlation_functions.R")

```

### load the data

```r
load("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/data/processed/all_cyt_met_standardized.RData")
```

## Separate T21 and D21 subjects

``` r
T21.mixed <- lapply(all_standardized, function(x) {
    x %>%
        filter(rownames(x) %in% (all_standardized$clinic %>% filter(Karyotype == "T21") %>% .$LabID))
})
D21.mixed <- lapply(all_standardized, function(x) {
    x %>%
        filter(rownames(x) %in% (all_standardized$clinic %>% filter(Karyotype == "Control") %>% .$LabID))
})


save(T21.mixed,file = "~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/data/processed/T21_standardized_cyt_met.RData")
save(D21.mixed,file= "~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/data/processed/D21_standardized_cyt_met.RData")

```

## Load the data in subsequent analyses

``` r
load("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/data/processed/T21_standardized_cyt_met.RData")
load("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/data/processed/D21_standardized_cyt_met.RData")
```

### Calculate the correlations within Cytokines

``` r
T21_cytokine_correlations <- T21.mixed$cytokines %>%
    corr.test(method = "spearman", adjust = "fdr")

D21_cytokine_correlations <- D21.mixed$cytokines %>%
    corr.test(method = "spearman", adjust = "fdr")

```

### Calculate the correlations within Metabolites

``` r
T21_metabolite_correlations <- T21.mixed$metabolites %>%
    corr.test(method = "spearman", adjust = "fdr")

D21_metabolite_correlations <- D21.mixed$metabolites %>%
    corr.test(method = "spearman", adjust = "fdr")

```

### Heatmaps

``` r
cyt_heatmap = Heatmap(T21_cytokine_correlations$
	r, 
	name = "conrrelation coefficient",
	row_dend_reorder = TRUE, 
	column_dend_reorder = TRUE, 
	show_row_dend = FALSE, 
	show_column_dend = TRUE, 
	column_names_gp = gpar(fontsize = 7),
	row_names_gp = gpar(fontsize = 7), 
	show_row_names = TRUE, 
	show_column_names = FALSE,
	column_split = 4,
	row_split = 4,
	row_title = NULL,
	column_title = NULL,
	col=colorRamp2(c(-.5, 0, .5), c("blue", "white", "red")),
	heatmap_legend_param = list(direction = "horizontal")
    )

pdf("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/results/correlation_heatmaps/T21_Cytokines_Correlation_Heatmap.pdf")
draw(cyt_heatmap, heatmap_legend_side = "bottom")
dev.off()

```

``` r
met_heatmap = Heatmap(T21_metabolite_correlations$r, 
	name = "correlation coefficient",
	row_dend_reorder = TRUE, 
	column_dend_reorder = TRUE, 
	show_row_dend = FALSE, 
	show_column_dend = TRUE, 
	column_names_gp = gpar(fontsize = 3),
	row_names_gp = gpar(fontsize = 3), 
	show_row_names = TRUE, 
	show_column_names =FALSE,
	column_split = 4,
    row_title = NULL,
	row_split = 4,
	column_title = NULL,
	col=colorRamp2(c(-.5, 0, .5), c("blue", "white", "red")),
	heatmap_legend_param = list(direction = "horizontal")
    )
pdf("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/results/correlation_heatmaps/T21_Metabolites_Correlation_Heatmap.pdf")
draw(met_heatmap, heatmap_legend_side = "bottom")
dev.off()

```

### Calculate the correlations across molecular classs

``` r
T21.omics <- cbind( T21.mixed$cytokines, T21.mixed$metabolites)

T21_correlations <- T21.omics %>%
    corr.test(method = "spearman", adjust = "fdr")

D21.omics <- cbind( D21.mixed$cytokines,D21.mixed$metabolites)

D21_correlations <- D21.omics %>%
    corr.test(method = "spearman", adjust = "fdr")
```


### Heatmap of multiomic correlations

``` r
all_heatmap = Heatmap(T21_correlations$r, 
	name = "correlation coefficient",
	row_dend_reorder = TRUE, 
	column_dend_reorder = TRUE, 
	show_row_dend = FALSE, 
	show_column_dend = TRUE, 
	column_names_gp = gpar(fontsize = 3),
	row_names_gp = gpar(fontsize = 2), 
	show_row_names = TRUE, 
	show_column_names =FALSE,
	column_split = 4,
    row_title = NULL,
	row_split = 4,
	column_title = NULL,
	col=colorRamp2(c(-.5, 0, .5), c("blue", "white", "red")),
	heatmap_legend_param = list(direction = "horizontal")
    )
pdf("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/results/correlation_heatmaps/T21_ALL_Correlation_Heatmap.pdf")
draw(all_heatmap, heatmap_legend_side = "bottom")
dev.off()

```



### Cytokine-metabolite scatter plots

#### Convert data to long format

``` r

T21_cytokine_correlations <- LongCorr(T21_cytokine_correlations)
T21_metabolite_correlations <- LongCorr(T21_metabolite_correlations)
T21_correlations <- LongCorr(T21_correlations)

T21_correlations$long <- T21_correlations$long %>%
    filter(A %in% names(T21.mixed$cytokines) & B %in% names(T21.mixed$metabolites))

```

#### Plot creation
```r
corrScatterPlotsSingle(psych_object = T21_cytokine_correlations,
                       molecule_class = "cytokines",
                       omics_data = T21.mixed)


corrScatterPlotsSingle(psych_object = T21_metabolite_correlations,
                       molecule_class = "metabolites",
                       omics_data = T21.mixed)



corrScatterPlotsMultiple(psych_object = T21_correlations,
                       molecule_classes = c("cytokines","metabolites"),
                       omics_data = T21.mixed)					   
```


### Compare T21 and D21 Correlations

```r
library(ggrepel)
D21_correlations <- LongCorr(D21_correlations)
D21_correlations$long <- D21_correlations$long %>%
    filter(A %in% names(D21.mixed$cytokines) & B %in% names(D21.mixed$metabolites))

all_correlations <- T21_correlations$long %>%
    full_join(D21_correlations$long, by = c("A","B"))

names(all_correlations) <- c("cytokine", "metabolite", "T21_r", "T21_fdr", "D21_r", "D21_fdr")

all_correlations$significance <- ifelse(all_correlations$T21_fdr < .1 & all_correlations$D21_fdr < .1, "Both",
                                 ifelse(all_correlations$T21_fdr < .1 & all_correlations$D21_fdr > .1, "T21 only",
                                        ifelse(all_correlations$T21_fdr > .1 & all_correlations$D21_fdr < .1, "D21 only", "None")))

all_correlations$diff <- abs(all_correlations$T21_r - all_correlations$D21_r)

all_correlations$label <- ifelse(all_correlations$diff > .5 & all_correlations$significance %in% c("T21 only","D21 only") , paste(all_correlations$cytokine, "-",all_correlations$metabolite), "")
all_correlations$label <- ifelse(abs(all_correlations$T21_r) > .35 | abs(all_correlations$D21_r) > .5 | all_correlations$diff > .55 , paste(all_correlations$cytokine, "-",all_correlations$metabolite), "")

p1 <- ggplot(all_correlations, aes(x = T21_r, y = D21_r, color = significance,label = label, alpha = significance ))+
    geom_point(size = 2) +
    geom_label_repel(max.overlaps = 1e6, size = 2)+
    theme_classic() +
    theme(legend.position = "bottom") +
    xlim(-.6,.6) + ylim(-.6,.6) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "grey") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
    scale_color_manual(values = c("Both" = "red", "T21 only" = "blue", "D21 only" = "brown", "None" = "gray"))+
    scale_alpha_manual(values = c(1,1,.2,1))   
pdf("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/results/correlation_scatter_plots/karyotype/T21_D21_correlation_scatter.pdf")
print(p1)
dev.off()



```


### Metabolite Pathway enrichment

``` r
load("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/data/pathway/metabolite_pathway.RData")

features <- T21_correlations$long %>%
    filter(A == "IL-7") %>%
    filter(fdr < .1) %>%
    .$B


pathEnrich(features, met_path)


```

