# Clustering of T21 subjects

## Load required scripts and packages
```r
source("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/R/data_prep_functions.R")
source("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/R/nemo_functions.R")
source("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/R/cluster_evaluation.R")
library(tidyverse)
```

## Set the seed for reproducibility

``` r
set.seed(1234)
```

## Load the data
```r
load("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/data/processed/T21_standardized_cyt_met.RData")
load("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/data/processed/processed_transcriptome.RData")
```

## Steps in clustering as defined by Milligan(1996)

1. Selection of objects and variables - overlap of cyt, met, RNA data (001)
2. Decisions concerning variable normalization - adjustment for age, sex, and sample_source, standardized (001)
3. Selection of a distance measure - NEMO (nemo_functions.R)
4. Selection of a clustering method - spectral clustering (nemo_functions.R)
5. Determining the numebr of clusters - (cluster_comparison.R)
6. Validating the clusters - 
7. Descibing and profiling the clusters - 


## Determining the number of clusters based on the number of overlaps between two co-occurring conditions
An  approach may consider that we are interested in finding axes of disease co-occurance among the data. Therefore, we will restrict our number of neighbors to the mean number of neighbors. 

``` r
overlap <- sapply(phenotypes[3:length(phenotypes)], function(x) {
    sapply(phenotypes[3:length(phenotypes)], function(y) {
        tmp <- table(T21.mixed$clinic[[x]],T21.mixed$clinic[[y]])
        return(tmp["1","1"])
    })})
    
num_neighbors = floor(mean(overlap[upper.tri(overlap)]))
omics.list = list(t(T21.mixed$cytokines),t(T21.mixed$metabolites))
NUMC <- 2:8

res <- clusterEval(omics.list = list(t(T21.mixed$cytokines),t(T21.mixed$metabolites)),
                clinic = T21.mixed$clinic,
                phenotypes = phenotypes,
                iterations = iterations,
                NUMC = NUMC,  
                diff_sig_threshold = diff_sig_threshold,
                clinical_threshold = clinical_threshold,
                num_neighbors = num_neighbors )

res$summary
res$eigengap
res$nemo
```

## How stable are the clusters over the number of neighbors?

``` r
num_neighbors_grid <- seq(10,60,10)

multi_omic_res = lapply(num_neighbors_grid, function(x) {
    print(x)
    clusterEval(omics.list = list(t(T21.mixed$cytokines),t(T21.mixed$metabolites)),
                clinic = T21.mixed$clinic,
                phenotypes = phenotypes,
                iterations = iterations,
                NUMC = NUMC,  
                diff_sig_threshold = diff_sig_threshold,
                clinical_threshold = clinical_threshold,
                num_neighbors = x)
})

lapply(multi_omic_res, function(x) x$nemo)
lapply(multi_omic_res, function(x) x$eigen)
lapply(multi_omic_res, function(x) x$summary)

```

## Perform the clustering

``` r
##detach("package:ComplexHeatmap", unload = TRUE)
diff_sig_threshold = .1
clinical_threshold = .2
NUMC = 2:8
phenotypes =  names(T21.mixed$clinic)[c(2,6,9:21)]


res <- clusterEval(omics.list = list(t(T21.mixed$cytokines),t(T21.mixed$metabolites)),
                clinic = T21.mixed$clinic,
                phenotypes = phenotypes,
                iterations = iterations,
                NUMC = NUMC,  
                diff_sig_threshold = diff_sig_threshold,
                clinical_threshold = clinical_threshold,
                num_neighbors = 20)
res$summary
res$eigen




write.csv(multi_omic_res$summary, row.names = F, file = "~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/results/tables/cyt_met_clustering_results.csv")


cytokine_res = clusterEval(omics.list = list(t(T21.mixed$cytokines)),
						clinic = T21.mixed$clinic,
					 	phenotypes = names(clinic[c(9:21)]),
					  	iterations = iterations, 
						NUMC = NUMC,  
                      diff_sig_threshold = diff_sig_threshold,
                      clinical_threshold = clinical_threshold,
                      num_neighbors = 20)
cytokine_res$summary
cytokine_res$eigengap
cytokine_res$nemo

metabolite_res = clusterEval(omics.list = list(t(T21.mixed$metabolites)),
						clinic = T21.mixed$clinic,
					 	phenotypes = names(clinic[c(9:21)]),
					  	iterations = iterations, 
						NUMC = NUMC,  
                      diff_sig_threshold = diff_sig_threshold ,
                      clinical_threshold = clinical_threshold,
                      num_neighbors = num_neighbors)
metabolite_res$summary
metabolite_res$eigengap
metabolite_res$nemo



write.csv(cytokine_res$summary, row.names = F, file = "~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/results/tables/cytokine_clustering_results.csv")
write.csv(metabolite_res$summary, row.names = F, file = "~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/results/tables/metabolite_clustering_results.csv")
```

## Choose Clustering based on results

``` r

```


## Clustering all 3 datasets
## Combine the metabolite, cytokine, and gene expression data
``` r
load("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/data/processed/processed_transcriptome.RData")
T21.expression <- expression_list$expression %>%
    filter(rownames(expression_list$expression) %in% rownames(T21.mixed$cytokines))
identical(rownames(T21.expression), rownames(T21.mixed$cytokines))
```

``` r
## Perform the clustering
omics.list <-  list(t(T21.mixed$cytokines),t(T21.mixed$metabolites), t(T21.expression))
diff_sig_threshold = .1
clinical_threshold = .2
iterations = 2
NUMC = 2:6
phenotypes =  names(T21.mixed$clinic)[c(2,6,9:21)]

all_omics_res = clusterEval(omics.list = omics.list,
						clinic = T21.mixed$clinic,
					 	phenotypes =phenotypes,
					  	iterations = iterations,
						NUMC = NUMC,  
                      diff_sig_threshold = diff_sig_threshold,
                      clinical_threshold = clinical_threshold)

write.csv(all_omics_res$summary, row.names = F, file = "~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/results/tables/cyt_met_gene_clustering_results.csv")

```
