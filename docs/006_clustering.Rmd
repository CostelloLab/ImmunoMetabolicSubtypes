# Clustering of T21 subjects

## Load required scripts and packages
```r
source("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/R/data_prep_functions.R")
source("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/R/nemo_functions.R")
source("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/R/cluster_evaluation.R")
library(tidyverse)
```

## Load the data
```r
load("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/data/processed/T21_standardized_cyt_met.RData")
load("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/data/processed/processed_transcriptome.RData")
```



## Perform the clustering

``` r
##detach("package:ComplexHeatmap", unload = TRUE)
diff_sig_threshold = .1
clinical_threshold = .2
NUMC = 2:8
phenotypes =  names(T21.mixed$clinic)[c(2,6,9:21)]
num_neighbors_grid <- seq(10,60,10)
multi_omic_res = lapply(num_neighbors_grid, function(x) {
    print(x)
    clusterEval(omics.list = list(t(T21.mixed$cytokines),t(T21.mixed$metabolites)),
                clinic = T21.mixed$clinic,
                phenotypes = phenotypes,
                iterations = iterations,
                NUMC = NUMC,  
                diff_sig_threshold = diff_sig_threshold,
                clinical_threshold = clinical_threshold,
                num_neighbors = x)
})
lapply(multi_omic_res, function(x) x$nemo)
lapply(multi_omic_res, function(x) x$eigen)
lapply(multi_omic_res, function(x) x$summary)



overlap <- sapply(phenotypes[3:length(phenotypes)], function(x) {
    sapply(phenotypes[3:length(phenotypes)], function(y) {
        tmp <- table(T21.mixed$clinic[[x]],T21.mixed$clinic[[y]])
        return(tmp["1","1"])
    })})
    
num_neighbors = floor(mean(overlap[upper.tri(overlap)]))

res <- clusterEval(omics.list = list(t(T21.mixed$cytokines),t(T21.mixed$metabolites)),
                clinic = T21.mixed$clinic,
                phenotypes = phenotypes,
                iterations = iterations,
                NUMC = NUMC,  
                diff_sig_threshold = diff_sig_threshold,
                clinical_threshold = clinical_threshold,
                num_neighbors = 20)
res$summary
res$eigen

write.csv(multi_omic_res$summary, row.names = F, file = "~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/results/tables/cyt_met_clustering_results.csv")


cytokine_res = clusterEval(omics.list = list(t(T21.mixed$cytokines)),
						clinic = T21.mixed$clinic,
					 	phenotypes = names(clinic[c(9:21)]),
					  	iterations = iterations, 
						NUMC = NUMC,  
                      diff_sig_threshold = diff_sig_threshold,
                      clinical_threshold = clinical_threshold,
                      num_neighbors = 20)
cytokine_res$summary
cytokine_res$eigengap
cytokine_res$nemo

metabolite_res = clusterEval(omics.list = list(t(T21.mixed$metabolites)),
						clinic = T21.mixed$clinic,
					 	phenotypes = names(clinic[c(9:21)]),
					  	iterations = iterations, 
						NUMC = NUMC,  
                      diff_sig_threshold = diff_sig_threshold ,
                      clinical_threshold = clinical_threshold,
                      num_neighbors = num_neighbors)
metabolite_res$summary
metabolite_res$eigengap
metabolite_res$nemo



write.csv(cytokine_res$summary, row.names = F, file = "~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/results/tables/cytokine_clustering_results.csv")
write.csv(metabolite_res$summary, row.names = F, file = "~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/results/tables/metabolite_clustering_results.csv")
```

## Choose Clustering based on results

``` r

```


## Clustering all 3 datasets
## Combine the metabolite, cytokine, and gene expression data
``` r
load("~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/data/processed/processed_transcriptome.RData")
T21.expression <- expression_list$expression %>%
    filter(rownames(expression_list$expression) %in% rownames(T21.mixed$cytokines))
identical(rownames(T21.expression), rownames(T21.mixed$cytokines))
```

``` r
## Perform the clustering
omics.list <-  list(t(T21.mixed$cytokines),t(T21.mixed$metabolites), t(T21.expression))
diff_sig_threshold = .1
clinical_threshold = .2
iterations = 2
NUMC = 2:6
phenotypes =  names(T21.mixed$clinic)[c(2,6,9:21)]

all_omics_res = clusterEval(omics.list = omics.list,
						clinic = T21.mixed$clinic,
					 	phenotypes =phenotypes,
					  	iterations = iterations,
						NUMC = NUMC,  
                      diff_sig_threshold = diff_sig_threshold,
                      clinical_threshold = clinical_threshold)

write.csv(all_omics_res$summary, row.names = F, file = "~/OneDrive - The University of Colorado Denver/Projects/ImmunoMetabolicSubtypes/results/tables/cyt_met_gene_clustering_results.csv")

```
